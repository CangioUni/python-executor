{% extends "base.html" %}

{% block title %}Script Manager - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-6">
                📋 Scripts Dashboard
            </h1>
            <a href="/add" class="btn btn-primary btn-lg">
                ➕ Add New Script
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    📝 Managed Scripts
                </h5>
            </div>
            <div class="card-body">
                {% if scripts %}
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>📄 Name</th>
                            <th>🔄 Policy</th>
                            <th>📊 Status</th>
                            <th>⚙️ Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for name, script in scripts.items() %}
                        <tr data-name="{{ name }}">
                            <td>
                                <a href="/script/{{ name }}" style="text-decoration: none; font-weight: 600;">
                                    🐍 {{ name }}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ script.policy }}</span>
                            </td>
                            <td>
                                <span class="badge status-badge" id="status-{{ name }}" data-status="{{ statuses[name] }}">
                                    {{ statuses[name] }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="/start/{{ name }}" class="btn btn-success btn-sm" title="Start Script">
                                        ▶️
                                    </a>
                                    <a href="/stop/{{ name }}" class="btn btn-danger btn-sm" title="Stop Script">
                                        ⏹️
                                    </a>
                                    <a href="/script/{{ name }}" class="btn btn-secondary btn-sm" title="View Details">
                                        👁️
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">📦</div>
                    <h3 class="text-muted">No Scripts Added Yet</h3>
                    <p class="text-muted mb-3">Get started by adding your first script to manage.</p>
                    <a href="/add" class="btn btn-primary">
                        ➕ Add Your First Script
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
    // Status badge styling function
    function updateStatusBadge(element, status) {
        element.textContent = status;
        element.setAttribute('data-status', status);
        
        // Remove all existing status classes
        element.className = 'badge status-badge';
        
        // Add appropriate Bootstrap class based on status
        switch(status.toLowerCase()) {
            case 'running':
                element.classList.add('bg-success');
                break;
            case 'stopped':
                element.classList.add('bg-secondary');
                break;
            case 'error':
                element.classList.add('bg-danger');
                break;
            case 'starting':
                element.classList.add('bg-warning');
                break;
            default:
                element.classList.add('bg-secondary');
        }
    }
    
    function setStatus(name, status){
        const el = document.getElementById('status-' + name);
        if(!el) return;
        updateStatusBadge(el, status);
    }
    
    // Initialize existing status badges
    document.querySelectorAll('.status-badge').forEach(badge => {
        const status = badge.getAttribute('data-status');
        if (status) {
            updateStatusBadge(badge, status);
        }
    });
    
    // WebSocket connection for real-time status updates
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/status');
    
    ws.onmessage = (ev) => {
        try {
            const data = JSON.parse(ev.data);
            Object.entries(data).forEach(([name, status])=> setStatus(name, status));
        } catch(e) { 
            console.error('Error parsing WebSocket message:', e);
        }
        // send a ping to keep the loop going server-side
        ws.send('ping');
    };
    
    ws.onopen = () => {
        console.log('WebSocket connected for status updates');
    };
    
    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        showToast('Connection error. Status updates may be delayed.', 'warning');
    };
    
    ws.onclose = () => {
        console.log('WebSocket connection closed');
        showToast('Real-time updates disconnected. Refresh to reconnect.', 'warning');
    };
})();
</script>
{% endblock %}